################################################################################
# üß© Docker Compose Configuration for Pi-hole DevOps Project
#
# Overview:
#   This Compose stack orchestrates three coordinated services:
#     1Ô∏è‚É£  Pi-hole          ‚Äî DNS-level ad blocker and local DNS resolver
#     2Ô∏è‚É£  Bash Monitor     ‚Äî Lightweight system resource monitor (CPU, RAM, Disk)
#     3Ô∏è‚É£  Python Monitor   ‚Äî Pi-hole API statistics collector (via REST API)
#
# Usage:
#   export PIHOLE_PASSWORD=MyPass123
#   docker compose up -d
#   docker compose logs -f
################################################################################

services:
  ##############################################################################
  # üß± SERVICE 1: Pi-hole ‚Äî DNS Ad Blocker + Web Dashboard (HOST MODE)
  #
  # Using host networking fully replicates the ‚Äúdocker run ‚Ä¶ --network host‚Äù
  # behavior from the official docs, and guarantees DNS works at 192.168.x.x.
  #
  # IMPORTANT:
  #   - network_mode: host ‚Üí Pi-hole is directly on the host network
  #   - ports: stay for clarity, but are ignored (host mode exposes everything)
  #   - other containers CANNOT reach Pi-hole via "pihole" hostname anymore
  #     ‚Üí They must use http://127.0.0.1 for API calls.
  ##############################################################################
  pihole:
    container_name: pihole
    image: pihole/pihole:latest
    network_mode: host
    hostname: pihole

    # DNS settings (matching official ‚Äúdocker run‚Äù behavior)
    dns:
      - 127.0.0.1
      - 1.1.1.1

    # These are ignored in host mode, but we keep them for readability
    ports:
      - "53:53/tcp"
      - "53:53/udp"
      - "80:80/tcp"
      - "443:443/tcp"

    environment:
      TZ: "Europe/Bucharest"

      # Correct API password for Pi-hole v6+
      FTLCONF_webserver_api_password: "${PIHOLE_PASSWORD}"

      # Upstream DNS servers
      DNS1: "1.1.1.1"
      DNS2: "8.8.8.8"

      # Misc DNS settings
      DNSSEC: "true"
      DNSMASQ_LISTENING: "all"
      PIHOLE_DNS_: "1.1.1.1;8.8.8.8"
      REV_SERVER: "false"

    volumes:
      - ./etc-pihole:/etc/pihole
      - ./etc-dnsmasq.d:/etc/dnsmasq.d

    cap_add:
      - NET_ADMIN

    restart: unless-stopped

    # Health check: verify DNS answers inside host network
    healthcheck:
      test: ["CMD", "dig", "@127.0.0.1", "pi.hole", "+short"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  ##############################################################################
  # üìä SERVICE 2: Bash System Monitor
  #
  # Notes:
  #   - This still uses the Docker network, not host network.
  #   - It cannot reach Pi-hole via hostname now ‚Üí only via host DNS.
  #   - But since this script monitors RESOURCES not API, it's OK.
  ##############################################################################
  bash-monitor:
    container_name: bash-monitor
    hostname: bash-monitor

    build:
      context: ..
      dockerfile: docker/Dockerfile.monitor-bash

    depends_on:
      pihole:
        condition: service_healthy

    environment:
      # This is kept only for logging consistency
      PIHOLE_HOST: "127.0.0.1"
      MONITOR_INTERVAL: "30"

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "pgrep", "-f", "system_monitor.sh"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    networks:
      - pihole-network

  ##############################################################################
  # üêç SERVICE 3: Python Pi-hole Monitor
  #
  # IMPORTANT:
  #   - Pi-hole runs in host network ‚Üí NOT reachable via Docker DNS
  #   - Must connect to http://127.0.0.1 (host's loopback)
  #
  # Using a short delay allows Pi-hole's webserver to fully start.
  ##############################################################################
  python-monitor:
    container_name: python-monitor
    hostname: python-monitor

    build:
      context: ..
      dockerfile: docker/Dockerfile.monitor-python

    depends_on:
      pihole:
        condition: service_healthy

    environment:
      PIHOLE_URL: "http://192.168.1.143"
      PIHOLE_API_KEY: "${PIHOLE_PASSWORD}"
      MONITOR_INTERVAL: "60"

    # Allow Pi-hole backend to fully boot
    command: ["sh", "-c", "sleep 10 && python3 /app/pihole_stats.py"]

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "pgrep", "-f", "pihole_stats.py"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 20s

    networks:
      - pihole-network

################################################################################
# üåê NETWORK (used by helper containers only)
################################################################################
networks:
  pihole-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

# SSJ

# ################################################################################
# # üß© Docker Compose Configuration for Pi-hole DevOps Project
# #
# # Overview:
# #   This Compose stack orchestrates three coordinated services:
# #     1Ô∏è‚É£  Pi-hole          ‚Äî DNS-level ad blocker and local DNS resolver
# #     2Ô∏è‚É£  Bash Monitor     ‚Äî Lightweight system resource monitor (CPU, RAM, Disk)
# #     3Ô∏è‚É£  Python Monitor   ‚Äî Pi-hole API statistics collector (via REST API)
# #
# # Prerequisites:
# #   1. Copy .env.example to .env and configure your settings
# #   2. Ensure ports 53, 80, 443 are free on host
# #   3. Disable systemd-resolved if needed
# #
# # Usage:
# #   docker compose up -d              # Start all services
# #   docker compose logs -f            # View logs
# #   docker compose down               # Stop all services
# #   docker compose restart pihole     # Restart single service
# ################################################################################

# services:
#   ##############################################################################
#   # üß± SERVICE 1: Pi-hole ‚Äî DNS Ad Blocker + Web Dashboard
#   #
#   # Using host networking for direct DNS access at port 53.
#   # This ensures Pi-hole is reachable from all devices on your LAN.
#   #
#   # Access Web UI: http://${HOST_IP}/admin or http://localhost/admin
#   ##############################################################################
#   pihole:
#     container_name: pihole
#     image: pihole/pihole:latest
#     network_mode: host
#     hostname: pihole

#     # DNS configuration
#     dns:
#       - 127.0.0.1
#       - ${DNS1:-1.1.1.1}

#     # Ports (informational only, host mode ignores port mappings)
#     ports:
#       - "53:53/tcp"
#       - "53:53/udp"
#       - "80:80/tcp"
#       - "443:443/tcp"

#     environment:
#       # Timezone for correct log timestamps
#       TZ: ${TZ:-Europe/Bucharest}

#       # Pi-hole v6+ password configuration
#       FTLCONF_webserver_api_password: ${PIHOLE_PASSWORD}

#       # Upstream DNS servers
#       DNS1: ${DNS1:-1.1.1.1}
#       DNS2: ${DNS2:-8.8.8.8}

#       # DNS security and configuration
#       DNSSEC: "true"
#       DNSMASQ_LISTENING: "all"
#       PIHOLE_DNS_: "${DNS1:-1.1.1.1};${DNS2:-8.8.8.8}"
#       REV_SERVER: "false"

#     # Persistent storage for Pi-hole configuration and blocklists
#     volumes:
#       - ./etc-pihole:/etc/pihole
#       - ./etc-dnsmasq.d:/etc/dnsmasq.d

#     # Required for network administration
#     cap_add:
#       - NET_ADMIN

#     # Always restart unless explicitly stopped
#     restart: unless-stopped

#     # Health check: verify DNS is responding
#     healthcheck:
#       test: ["CMD", "dig", "@127.0.0.1", "pi.hole", "+short"]
#       interval: 30s
#       timeout: 10s
#       retries: 3
#       start_period: 60s

#     # Labels for better container management
#     labels:
#       - "com.pihole-devops.service=pihole"
#       - "com.pihole-devops.description=DNS ad blocker"

#   ##############################################################################
#   # üìä SERVICE 2: Bash System Monitor
#   #
#   # Monitors system resources (CPU, RAM, Disk) and Docker container status.
#   # Runs in bridge network but can still monitor host resources.
#   ##############################################################################
#   bash-monitor:
#     container_name: bash-monitor
#     hostname: bash-monitor

#     # Build from Dockerfile
#     build:
#       context: ..
#       dockerfile: docker/Dockerfile.monitor-bash

#     # Wait for Pi-hole to be healthy before starting
#     depends_on:
#       pihole:
#         condition: service_healthy

#     environment:
#       # Pi-hole host (localhost since Pi-hole is in host network)
#       PIHOLE_HOST: "127.0.0.1"
      
#       # Monitoring interval in seconds
#       MONITOR_INTERVAL: ${BASH_MONITOR_INTERVAL:-30}

#     # Mount Docker socket to monitor containers (read-only for security)
#     volumes:
#       - /var/run/docker.sock:/var/run/docker.sock:ro

#     # Always restart unless explicitly stopped
#     restart: unless-stopped

#     # Health check: verify monitoring script is running
#     healthcheck:
#       test: ["CMD", "pgrep", "-f", "system_monitor.sh"]
#       interval: 30s
#       timeout: 10s
#       retries: 3
#       start_period: 10s

#     # Connect to bridge network (not host mode)
#     networks:
#       - pihole-network

#     # Labels for better container management
#     labels:
#       - "com.pihole-devops.service=bash-monitor"
#       - "com.pihole-devops.description=System resource monitor"

#   ##############################################################################
#   # üêç SERVICE 3: Python Pi-hole Monitor
#   #
#   # Collects and displays Pi-hole statistics via REST API.
#   # Connects to Pi-hole on localhost (host network mode).
#   ##############################################################################
#   python-monitor:
#     container_name: python-monitor
#     hostname: python-monitor

#     # Build from Dockerfile
#     build:
#       context: ..
#       dockerfile: docker/Dockerfile.monitor-python

#     # Wait for Pi-hole to be healthy before starting
#     depends_on:
#       pihole:
#         condition: service_healthy

#     environment:
#       # Pi-hole API URL (localhost since Pi-hole is in host network)
#       PIHOLE_URL: "http://${HOST_IP:-127.0.0.1}"
      
#       # API authentication key
#       PIHOLE_API_KEY: ${PIHOLE_PASSWORD}
      
#       # Monitoring interval in seconds
#       MONITOR_INTERVAL: ${PYTHON_MONITOR_INTERVAL:-60}

#     # Delay startup to ensure Pi-hole API is fully ready
#     command: ["sh", "-c", "sleep 10 && python3 /app/pihole_stats.py"]

#     # Always restart unless explicitly stopped
#     restart: unless-stopped

#     # Health check: verify Python script is running
#     healthcheck:
#       test: ["CMD", "pgrep", "-f", "pihole_stats.py"]
#       interval: 60s
#       timeout: 10s
#       retries: 3
#       start_period: 20s

#     # Connect to bridge network
#     networks:
#       - pihole-network

#     # Labels for better container management
#     labels:
#       - "com.pihole-devops.service=python-monitor"
#       - "com.pihole-devops.description=Pi-hole API statistics collector"

# ################################################################################
# # üåê NETWORKS
# #
# # Bridge network for monitor containers to communicate.
# # Pi-hole uses host network, so monitors can't reach it via Docker DNS.
# ################################################################################
# networks:
#   pihole-network:
#     driver: bridge
#     ipam:
#       driver: default
#       config:
#         - subnet: 172.20.0.0/16
#     labels:
#       - "com.pihole-devops.network=monitoring"

# ################################################################################
# # üì¶ VOLUMES (Optional named volumes instead of bind mounts)
# #
# # Uncomment below and change service volume definitions to use named volumes:
# #   volumes:
# #     - pihole-data:/etc/pihole
# #     - dnsmasq-data:/etc/dnsmasq.d
# ################################################################################
# # volumes:
# #   pihole-data:
# #     driver: local
# #     labels:
# #       - "com.pihole-devops.volume=pihole-config"
# #   
# #   dnsmasq-data:
# #     driver: local
# #     labels:
# #       - "com.pihole-devops.volume=dnsmasq-config"