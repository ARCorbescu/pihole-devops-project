# Pi-hole DevOps Project

**Automated Pi-hole DNS Server Deployment on AWS**

A complete Infrastructure-as-Code (IaC) solution that deploys a Pi-hole DNS server on AWS EC2 using Terraform and Ansible.

---

## üìã Table of Contents
- [Quick Start](#quick-start)
- [Project Structure](#project-structure)
- [Prerequisites](#prerequisites)
- [Deployment](#deployment)
- [Documentation](#documentation)
- [Features](#features)

---

## üöÄ Quick Start

```bash
# 1. Clone the repository
git clone https://github.com/ARCorbescu/pihole-devops-project.git
cd pihole-devops-project

# 2. Provision AWS infrastructure
cd terraform
terraform init
terraform apply

# 3. Deploy Pi-hole
cd ../ansible
ansible-galaxy install geerlingguy.docker
ansible-playbook -i inventory.ini playbook.yml --ask-vault-pass
```

---

## üìÅ Project Structure

```
pihole-devops-project/
‚îú‚îÄ‚îÄ terraform/                    # Infrastructure provisioning
‚îÇ   ‚îú‚îÄ‚îÄ main.tf                   # EC2, Security Groups, SSH Keys
‚îÇ   ‚îú‚îÄ‚îÄ inventory.tf              # Auto-generates Ansible inventory
‚îÇ   ‚îú‚îÄ‚îÄ provider.tf               # AWS provider configuration
‚îÇ   ‚îî‚îÄ‚îÄ pihole_key                # SSH private key (generated)
‚îÇ
‚îú‚îÄ‚îÄ ansible/                      # Configuration management
‚îÇ   ‚îú‚îÄ‚îÄ playbook.yml              # Main deployment playbook
‚îÇ   ‚îú‚îÄ‚îÄ vault.yml                 # Encrypted secrets (Pi-hole password)
‚îÇ   ‚îú‚îÄ‚îÄ inventory.ini             # Auto-generated by Terraform
‚îÇ   ‚îú‚îÄ‚îÄ group_vars/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ all.yml               # Global variables
‚îÇ   ‚îî‚îÄ‚îÄ roles/                    # Modular Ansible roles
‚îÇ       ‚îú‚îÄ‚îÄ pihole-system-setup/  # System dependencies (git, curl)
‚îÇ       ‚îú‚îÄ‚îÄ pihole-clone-repo/    # Clone project from GitHub
‚îÇ       ‚îú‚îÄ‚îÄ pihole-docker-deployment/  # Pull & build Docker images
‚îÇ       ‚îú‚îÄ‚îÄ pihole-disable-dns/   # Disable systemd-resolved
‚îÇ       ‚îî‚îÄ‚îÄ pihole-start-services/  # Start Pi-hole containers
‚îÇ
‚îú‚îÄ‚îÄ docker/                       # Docker Compose configuration
‚îÇ   ‚îú‚îÄ‚îÄ docker-compose.yml        # Pi-hole + monitoring services
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile.monitor-bash   # System resource monitor
‚îÇ   ‚îî‚îÄ‚îÄ Dockerfile.monitor-python # Pi-hole stats API
‚îÇ
‚îú‚îÄ‚îÄ scripts/                      # Utility scripts
‚îÇ   ‚îú‚îÄ‚îÄ pihole_stats.py           # Pi-hole statistics webhook
‚îÇ   ‚îú‚îÄ‚îÄ update_ip.py              # Dynamic IP updater for Security Groups
‚îÇ   ‚îú‚îÄ‚îÄ requirements.txt          # Python dependencies
‚îÇ   ‚îî‚îÄ‚îÄ system_monitor.sh         # Bash system monitor
‚îÇ
‚îî‚îÄ‚îÄ docs/                         # Documentation
    ‚îú‚îÄ‚îÄ INSTALLATION.md           # Step-by-step installation guide
    ‚îú‚îÄ‚îÄ USAGE.md                  # How to use the deployed system
    ‚îú‚îÄ‚îÄ ARCHITECTURE.md           # Technical architecture deep-dive
    ‚îî‚îÄ‚îÄ cheat_sheet.md            # Quick command reference
```

---

## ‚úÖ Prerequisites

### Required Tools
- **Terraform** >= 1.5.0
- **Ansible** >= 2.10
- **AWS CLI** (configured with credentials)
- **Python** >= 3.8
- **Git**

### AWS Requirements
- AWS account with EC2 permissions
- Configured AWS credentials (`~/.aws/credentials`)
- Available Elastic IP (optional but recommended)

### Local Setup
```bash
# Install Ansible Galaxy role for Docker
ansible-galaxy install geerlingguy.docker

# Verify AWS CLI configuration
aws sts get-caller-identity
```

---

## üö¢ Deployment

### Step 1: Provision Infrastructure (Terraform)
```bash
cd terraform
terraform init
terraform apply
```

**What this does:**
- Creates an EC2 instance (`t3.micro`, Ubuntu 22.04)
- Configures Security Groups (SSH, HTTP, DNS, Webhook)
- Generates SSH key pair
- Creates `ansible/inventory.ini` automatically

### Step 2: Deploy Pi-hole (Ansible)
```bash
cd ../ansible
ansible-playbook -i inventory.ini playbook.yml --ask-vault-pass
```

**Deployment Flow:**
1. **System Setup** - Installs git, curl, ca-certificates
2. **Docker Installation** - Uses `geerlingguy.docker` role
3. **Clone Repository** - Pulls project from GitHub
4. **Build Images** - Pulls and builds Docker images (while DNS works)
5. **Disable System DNS** - Stops `systemd-resolved`, frees port 53
6. **Start Pi-hole** - Launches containers, configures Pi-hole v6

---

## üìö Documentation

| Document | Description |
|----------|-------------|
| [INSTALLATION.md](docs/INSTALLATION.md) | Complete installation walkthrough |
| [USAGE.md](docs/USAGE.md) | How to use Pi-hole, webhooks, and utilities |
| [ARCHITECTURE.md](docs/ARCHITECTURE.md) | Technical deep-dive and design decisions |
| [cheat_sheet.md](docs/cheat_sheet.md) | Quick command reference |

---

## ‚ú® Features

### Infrastructure
- ‚úÖ **Terraform-managed AWS infrastructure**
- ‚úÖ **Automated inventory generation**
- ‚úÖ **Security Group with IP whitelisting**
- ‚úÖ **SSH key pair management**

### Configuration Management
- ‚úÖ **Modular Ansible roles** (single-responsibility design)
- ‚úÖ **Ansible Vault** for secret management
- ‚úÖ **Idempotent playbooks** (safe to re-run)
- ‚úÖ **External role integration** (`geerlingguy.docker`)

### Pi-hole Deployment
- ‚úÖ **Pi-hole v6** with custom configuration
- ‚úÖ **Docker Compose** multi-service stack
- ‚úÖ **System monitoring** (Bash + Python)
- ‚úÖ **Webhook API** for statistics (port 5005)

### Automation & Utilities
- ‚úÖ **Dynamic IP updater** (`scripts/update_ip.py`)
- ‚úÖ **"Pull-First" deployment strategy** (prevents DNS errors)
- ‚úÖ **Automatic DNS switchover** (systemd-resolved ‚Üí Pi-hole)

---

## üîí Security

- **IP Whitelisting**: Security Group restricts access to your IP only
- **Encrypted Secrets**: Ansible Vault protects sensitive data
- **SSH Key Authentication**: No password-based login
- **Minimal Attack Surface**: Only required ports exposed (22, 53, 80, 5005)

---

## üõ†Ô∏è Maintenance

### Update Pi-hole
```bash
ssh -i terraform/pihole_key ubuntu@<IP> "docker exec pihole pihole -up"
```

### View Logs
```bash
ssh -i terraform/pihole_key ubuntu@<IP> "docker compose -f ~/pihole-devops-project/docker/docker-compose.yml logs -f"
```

### Destroy Infrastructure
```bash
cd terraform
terraform destroy
```

---

## üìñ Learning Resources

This project demonstrates:
- **Infrastructure as Code** (Terraform)
- **Configuration Management** (Ansible)
- **Containerization** (Docker, Docker Compose)
- **AWS Services** (EC2, Security Groups, VPC)
- **DNS Management** (Pi-hole, systemd-resolved)
- **Secret Management** (Ansible Vault)
- **Modular Design** (Ansible roles)

---

## üìù License

MIT License - See [LICENSE](LICENSE) for details

---

## ü§ù Contributing

Contributions welcome! Please open an issue or submit a pull request.

---

**Author**: ARCorbescu  
**Repository**: https://github.com/ARCorbescu/pihole-devops-project
